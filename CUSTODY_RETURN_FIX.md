# ๐ง ุญู ูุดููุฉ ุฑุฏ ุงูุนูุฏุฉ - Custody Return Error Fix

## ุงููุดููุฉ
ุนูุฏ ูุญุงููุฉ ุฅุฑุณุงู ุทูุจ ุฑุฏ ุงูุนูุฏุฉ ูู ุตูุญุฉ:
```
POST /custodies/1/return
```
ูุธูุฑ ุฎุทุฃ **500 Server Error**

## ุงูุณุจุจ ุงูุฃุณุงุณู

### โ ุงูุฎุทุฃ ุงูุฃูู: ุญุณุงุจ ุงูุฑุตูุฏ ุงููุชุจูู ุฎุงุทุฆ
ูู `CustodyController::return()` (ุงูุณุทุฑ 92):

**ุงูููุฏ ุงููุฏูู:**
```php
'max:' . ($custody->amount - $custody->spent)
```

**ุงููุดููุฉ:**
- ูุญุณุจ ุงูุญุฏ ุงูุฃูุตู ููุฑุฏ ูู: `ุงููุจูุบ ุงูููู - ุงููุตุฑูู`
- **ูุชุฌุงูู** ุงููุจุงูุบ ุงููุฑุฌุนุฉ ุณุงุจูุงู (`$custody->returned`)

**ูุซุงู ููุถุญ ุงูุฎุทุฃ:**
```
ุงููุจูุบ ุงูููู:      1000 ุฑูุงู
ุงููุตุฑูู:          300 ุฑูุงู
ุงููุฑุฌุน ุณุงุจูุงู:     200 ุฑูุงู
ุงูุฑุตูุฏ ุงููุชุจูู:    500 ุฑูุงู (1000 - 300 - 200)

ุงูุญุณุงุจ ุงูุฎุงุทุฆ: 1000 - 300 = 700 โ
ุงูุญุณุงุจ ุงูุตุญูุญ:  1000 - 300 - 200 = 500 โ
```

### โ ุงูุฎุทุฃ ุงูุซุงูู: ุนุฏู ุงูุชุญูู ูู ูุฌูุฏ ุงูุฎุฒููุฉ
ูู ุนุฏุฉ ูุญุฏุงุช ุชุญูู:
```php
Treasury::first()->id  // ูุฏ ุชุฑุฌุน null!
```

---

## ุงูุญู ุงููุทุจู

### 1. โ ุฅุตูุงุญ ุญุณุงุจ ุงูุฑุตูุฏ ุงููุชุจูู
ูู [app/Http/Controllers/CustodyController.php](app/Http/Controllers/CustodyController.php):

**ูุจู:**
```php
public function return(Custody $custody, Request $request)
{
    $this->authorize('receive_custody');
    $request->validate([
        'returned_amount' => 'required|numeric|min:1|max:' . ($custody->amount - $custody->spent),
    ]);
```

**ุจุนุฏ:**
```php
public function return(Custody $custody, Request $request)
{
    $this->authorize('receive_custody');

    $remainingBalance = $custody->getRemainingBalance();

    $request->validate([
        'returned_amount' => 'required|numeric|min:1|max:' . $remainingBalance,
    ]);
```

### 2. โ ุฅุถุงูุฉ ูุญุต Treasury ูู CustodyController

**ูู `create()` method:**
```php
$treasury = Treasury::first();

if (!$treasury) {
    return redirect()->route('custodies.index')
        ->with('error', 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุฎุฒููุฉ. ูุฑุฌู ุงูุงุชุตุงู ุจุงููุณุคูู.');
}
```

**ูู `store()` method:**
```php
$treasury = Treasury::first();
if (!$treasury) {
    return back()->with('error', 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุฎุฒููุฉ. ูุฑุฌู ุงูุงุชุตุงู ุจุงููุณุคูู.');
}
```

### 3. โ ุฅุถุงูุฉ ูุญุต Treasury ูู TreasuryController

**ูู `index()` method:**
```php
$treasury = Treasury::first();

if (!$treasury) {
    return view('treasury.modern', [
        'treasury' => null,
        'error' => 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุฎุฒููุฉ. ูุฑุฌู ุงูุงุชุตุงู ุจุงููุณุคูู.'
    ]);
}
```

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### ุนูู Production Server:

#### ุงูุฎุทูุฉ 1: ุชุญุฏูุซ ุงููููุงุช
```bash
cd /path/to/charity.masarsoft.io
git pull origin main
```

#### ุงูุฎุทูุฉ 2: ุชูุธูู ุงูู Cache (ุงุฎุชูุงุฑู)
```bash
php artisan cache:clear
php artisan config:clear
```

#### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ
ูุง ุญุงุฌุฉ ูุชุดุบูู migrations ุฃู seeders - ุงูุชุบููุฑุงุช ุนูู ุงูููุฏ ููุท.

---

## โ ุงุฎุชุจุงุฑ ุงููุฌุงุญ

### 1๏ธโฃ ุงุฎุชุจุฑ ุฑุฏ ุนูุฏุฉ ุจูุจูุบ ุฃูู ูู ุงูุฑุตูุฏ ุงููุชุจูู

```
ุงูุนูุฏุฉ ุงูุฃุตููุฉ:    1000 ุฑูุงู
ุงููุตุฑูู:          400 ุฑูุงู
ุงููุฑุฌุน:           200 ุฑูุงู
ุงูุฑุตูุฏ ุงููุชุจูู:    400 ุฑูุงู

ูุญุงููุฉ ุงูุฑุฏ:       300 ุฑูุงู โ (ุฃูู ูู 400)
ุงููุชูุฌุฉ:         ูุฌุจ ุฃู ุชูุฌุญ
```

### 2๏ธโฃ ุงุฎุชุจุฑ ุฑุฏ ุนูุฏุฉ ุจูุจูุบ ุฃูุจุฑ ูู ุงูุฑุตูุฏ ุงููุชุจูู

```
ูุญุงููุฉ ุงูุฑุฏ:       500 ุฑูุงู โ (ุฃูุซุฑ ูู 400)
ุงููุชูุฌุฉ:         ุฎุทุฃ Validation: "ุงูุญุฏ ุงูุฃูุณู 400 ุฑูุงู"
```

### 3๏ธโฃ ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ ุนููููุง

1. ุงูุชุญ ุตูุญุฉ ุงูุนูุงุฏุงุช: `https://charity.masarsoft.io/custodies`
2. ุงุฎุชุฑ ุนูุฏุฉ ููุจููุฉ (status = accepted)
3. ุงุถุบุท ุนูู ุฒุฑ "ุฑุฏ ุงูุนูุฏุฉ" ุฃู "Return Custody"
4. ุฃุฏุฎู ูุจูุบ ุฃูู ูู ุงูุฑุตูุฏ ุงููุชุจูู
5. ุงุถุบุท "ุฅุฑุณุงู" ุฃู "Submit"
6. ูุฌุจ ุฃู ุชุญุตู ุนูู ุฑุณุงูุฉ ูุฌุงุญ โ

---

## ๐ฏ ุงูููุงุฆุฏ

| ุงููุงุฆุฏุฉ | ุงูุชูุงุตูู |
|--------|----------|
| **ุฅุตูุงุญ ุงูุจฺฏ** | ุฑุฏ ุงูุนูุงุฏุงุช ูุนูู ุจุดูู ุตุญูุญ ุงูุขู |
| **ุงูุญูุงูุฉ** | ูุญุต Treasury ุชุฏุงูุนู ูููุน ุฃุฎุทุงุก null |
| **ุณูููุฉ ุงูุงุณุชุฎุฏุงู** | ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุนุฑุจูุฉ |
| **ุงูุฃุฏุงุก** | ุงุณุชุฎุฏุงู `getRemainingBalance()` ูู ุงูู Model |

---

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### ุญุณุงุจ ุงูุฑุตูุฏ ุงููุชุจูู
ูู [app/Models/Custody.php](app/Models/Custody.php):

```php
public function getRemainingBalance()
{
    return $this->amount - $this->spent - $this->returned;
}
```

ูุฐุง ูุญุณุจ ุงูุฑุตูุฏ ุงููุนูู ุงููุชุงุญ ููุฑุฏ.

### ุญุงูุงุช ุงูุงุณุชุฎุฏุงู

| ุงูุญุงูุฉ | ุงูุญุณุงุจ | ุงููุซุงู |
|--------|--------|---------|
| ุฑุฏ ุฌุฏูุฏ | `amount - spent - returned` | 1000 - 400 - 0 = 600 |
| ุฑุฏ ุฌุฒุฆู | `amount - spent - returned` | 1000 - 400 - 200 = 400 |
| ุฑุฏ ูุงูู | `amount - spent - returned` | 1000 - 400 - 600 = 0 |

---

## ๐ ููุฎุต ุงูุชุนุฏููุงุช

```
ุงููููุงุช ุงููุนุฏูุฉ: 2
ุงูุณุทูุฑ ุงููุถุงูุฉ: 20
ุงูุณุทูุฑ ุงููุญุฐููุฉ: 2

ุงูุชุฃุซูุฑ: ุฅุตูุงุญ ุญุฑุฌ ููุนูููุงุช ุงููุงููุฉ
```

---

## ๐ ุงููููุงุช ุฐุงุช ุงูุตูุฉ

- [app/Http/Controllers/CustodyController.php](app/Http/Controllers/CustodyController.php) - ูุญุฏุฉ ุชุญูู ุงูุนูุงุฏุงุช
- [app/Http/Controllers/TreasuryController.php](app/Http/Controllers/TreasuryController.php) - ูุญุฏุฉ ุชุญูู ุงูุฎุฒููุฉ
- [app/Models/Custody.php](app/Models/Custody.php) - ูููุฐุฌ ุงูุนูุฏุฉ
- [app/Services/TreasuryService.php](app/Services/TreasuryService.php) - ุฎุฏูุฉ ุงูุฎุฒููุฉ

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2026-02-05
**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุฅูุชุงุฌ
